name: Sysdig Voting App Image Scans

on:
  workflow_dispatch:

jobs:
  scan-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build vote image
        run: docker build -t vote-app:latest ./vote

      - name: Build worker image
        run: docker build -t worker-app:latest ./worker

      - name: Build result image
        run: docker build -t result-app:latest ./result

      # Scan vote image
      - name: Scan vote image (standalone)
        id: scan-vote
        uses: sysdiglabs/scan-action@v6
        with:
          image-tag: vote-app:latest
          standalone: true
          db-path: ./sysdig-db
          stop-on-processing-error: true
          skip-upload: false
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}

      - name: Upload vote SARIF
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/sarif.json

      # Scan worker image
      - name: Scan worker image (standalone)
        id: scan-worker
        uses: sysdiglabs/scan-action@v6
        with:
          image-tag: worker-app:latest
          standalone: true
          db-path: ./sysdig-db
          stop-on-processing-error: true
          skip-upload: false
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}

      - name: Upload worker SARIF
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/sarif.json

      # Scan result image
      - name: Scan result image (standalone)
        id: scan-result
        uses: sysdiglabs/scan-action@v6
        with:
          image-tag: result-app:latest
          standalone: true
          db-path: ./sysdig-db
          stop-on-processing-error: true
          skip-upload: false
          sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}

      - name: Upload result SARIF
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/sarif.json
